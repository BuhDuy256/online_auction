@startuml UC06_WatchList
' --- Sequence Diagram: Watchlist Management ---
' Features: Add to watchlist, Remove from watchlist, View watchlist
' Database: watchlist(user_id, product_id) - Composite PK

autonumber
actor Bidder
participant "Web Browser" as Browser
participant "Web Server\n(Controller)" as Controller
participant "Watchlist Service" as WatchlistService
participant "Watchlist Repository" as WatchlistRepo
database "Database" as DB

== Operation 1: Add to Watchlist ==

Bidder -> Browser : Click "ThÃªm vÃ o Watch List" button on product page
Browser -> Controller : POST /products/:product_id/watchlist

activate Controller
Controller -> Controller : Authenticate user â†’ get user_id
Controller -> WatchlistService : addToWatchlist(user_id, product_id)
activate WatchlistService

' Check if already exists
WatchlistService -> WatchlistRepo : exists(user_id, product_id)
activate WatchlistRepo
WatchlistRepo -> DB : SELECT 1 FROM watchlist\nWHERE user_id = :user_id\n  AND product_id = :product_id
activate DB
DB --> WatchlistRepo : Boolean result
deactivate DB
deactivate WatchlistRepo

alt Product not in watchlist
    ' Add to watchlist
    WatchlistService -> WatchlistRepo : insert(user_id, product_id)
    activate WatchlistRepo
    WatchlistRepo -> DB : INSERT INTO watchlist\n(user_id, product_id)\nVALUES (:user_id, :product_id)
    note right
      Composite PK: (user_id, product_id)
      Prevents duplicates automatically
    end note
    activate DB
    DB --> WatchlistRepo : Inserted
    deactivate DB
    deactivate WatchlistRepo
    
    WatchlistService --> Controller : {success: true, message: "ÄÃ£ thÃªm vÃ o watchlist"}
    deactivate WatchlistService
    
    Controller -> Browser : HTTP 201 Created\n{in_watchlist: true}
    deactivate Controller
    
    Browser -> Browser : Update UI:\n- Button text: "â¤ï¸ ÄÃ£ thÃªm" (red heart)\n- Show toast: "ÄÃ£ thÃªm vÃ o danh sÃ¡ch theo dÃµi"

else Product already in watchlist
    WatchlistService --> Controller : {success: false, message: "Sáº£n pháº©m Ä‘Ã£ cÃ³ trong watchlist"}
    deactivate WatchlistService
    Controller -> Browser : HTTP 409 Conflict
    deactivate Controller
    Browser -> Bidder : Show message: "Sáº£n pháº©m Ä‘Ã£ cÃ³ trong danh sÃ¡ch theo dÃµi"
end

== Operation 2: Remove from Watchlist ==

Bidder -> Browser : Click "XÃ³a khá»i Watch List" (or toggle button)
Browser -> Controller : DELETE /products/:product_id/watchlist

activate Controller
Controller -> Controller : Authenticate user â†’ get user_id
Controller -> WatchlistService : removeFromWatchlist(user_id, product_id)
activate WatchlistService

WatchlistService -> WatchlistRepo : delete(user_id, product_id)
activate WatchlistRepo
WatchlistRepo -> DB : DELETE FROM watchlist\nWHERE user_id = :user_id\n  AND product_id = :product_id
activate DB
DB --> WatchlistRepo : Rows affected (0 or 1)
deactivate DB
deactivate WatchlistRepo

alt Deleted successfully (rows > 0)
    WatchlistService --> Controller : {success: true, message: "ÄÃ£ xÃ³a khá»i watchlist"}
    deactivate WatchlistService
    Controller -> Browser : HTTP 200 OK\n{in_watchlist: false}
    deactivate Controller
    Browser -> Browser : Update UI:\n- Button text: "ğŸ¤ ThÃªm vÃ o watchlist" (white heart)\n- Show toast: "ÄÃ£ xÃ³a khá»i danh sÃ¡ch theo dÃµi"

else Not found (rows = 0)
    WatchlistService --> Controller : {success: false, message: "KhÃ´ng tÃ¬m tháº¥y"}
    deactivate WatchlistService
    Controller -> Browser : HTTP 404 Not Found
    deactivate Controller
end

== Operation 3: View My Watchlist ==

Bidder -> Browser : Navigate to "Danh sÃ¡ch theo dÃµi" page
Browser -> Controller : GET /watchlist

activate Controller
Controller -> Controller : Authenticate user â†’ get user_id
Controller -> WatchlistService : getWatchlist(user_id)
activate WatchlistService

WatchlistService -> WatchlistRepo : findByUserId(user_id)
activate WatchlistRepo
WatchlistRepo -> DB : SELECT p.product_id, p.name, p.thumbnail_url,\n  p.current_price, p.end_time, p.bid_count,\n  p.status,\n  c.name as category_name,\n  CASE\n    WHEN p.end_time < CURRENT_TIMESTAMP THEN 'expired'\n    WHEN p.status = 'sold' THEN 'sold'\n    WHEN p.status = 'active' THEN 'active'\n    ELSE 'unavailable'\n  END as display_status\nFROM watchlist w\nJOIN products p ON w.product_id = p.product_id\nJOIN categories c ON p.category_id = c.category_id\nWHERE w.user_id = :user_id\nORDER BY\n  CASE WHEN p.status = 'active' AND p.end_time > CURRENT_TIMESTAMP THEN 0 ELSE 1 END,\n  p.end_time ASC
note right
  Sort priority:
  1. Active products first
  2. By end_time (soonest first)
  
  Display status:
  - active: Show countdown, "Äáº·t giÃ¡" button
  - expired: Gray out, "ÄÃ£ háº¿t háº¡n"
  - sold: "ÄÃ£ bÃ¡n"
end note
activate DB
DB --> WatchlistRepo : List of watchlist products
deactivate DB
deactivate WatchlistRepo

WatchlistService --> Controller : List of products with status
deactivate WatchlistService

Controller -> Browser : Render watchlist page with products
deactivate Controller

Browser -> Bidder : Display watchlist grid:\n- Product cards with status\n- Remove button (âŒ) on each card\n- Filter: "Äang diá»…n ra" / "ÄÃ£ káº¿t thÃºc"

== Alternative Flow: Toggle (Add/Remove in one action) ==

note right of Browser
  **Toggle Implementation:**
  
  Frontend:
  - Single button: "â¤ï¸ ÄÃ£ thÃªm" or "ğŸ¤ ThÃªm vÃ o watchlist"
  - On click: Check current state
  - If in_watchlist = true â†’ Call DELETE
  - If in_watchlist = false â†’ Call POST
  
  Backend can also implement:
  POST /products/:product_id/watchlist/toggle
  - Check exists â†’ delete if true, insert if false
  - Return new state: {in_watchlist: boolean}
end note

== Notes ==

note right of DB
  **Database Table:**
  - watchlist(user_id, product_id)
    * PK: PRIMARY KEY (user_id, product_id)
    * FK: user_id â†’ users(user_id)
    * FK: product_id â†’ products(product_id)
    * No timestamp needed (simple tracking)
  
  **Business Rules:**
  - Bidder can add any active product to watchlist
  - Can add even if auction ended (for reference)
  - Cannot add own products (seller)
  - Composite PK prevents duplicates automatically
  
  **UI/UX:**
  - Heart icon toggle: white (not in) â†” red (in watchlist)
  - Show count: "15 ngÆ°á»i Ä‘ang theo dÃµi"
  - Email notification: "Sáº£n pháº©m báº¡n theo dÃµi sáº¯p háº¿t háº¡n"
  
  **Performance:**
  - Index: (user_id) for fast user watchlist lookup
  - Index: (product_id) for counting watchers
  - Consider adding created_at for "Theo dÃµi tá»« X ngÃ y trÆ°á»›c"
  
  **Notifications (future):**
  - Email when auction ending soon (1 hour)
  - Email when new bid on watched product
  - Push notification: "GiÃ¡ Ä‘áº¥u má»›i: 150,000Ä‘"
  
  **Analytics:**
  - Track watchlist count per product
  - Popular products: Most watchlisted
  - Conversion rate: watchlist â†’ bid
end note

@enduml
